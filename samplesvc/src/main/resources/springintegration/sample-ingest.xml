<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-sftp="http://www.springframework.org/schema/integration/sftp"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
  http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
  http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
  http://www.springframework.org/schema/integration/sftp
  http://www.springframework.org/schema/integration/sftp/spring-integration-sftp.xsd">


    <int:channel id="renameSuccessProcess"/>
    <int:channel id="renameFailedProcess"/>
    <int:publish-subscribe-channel id="errorUploadChannel" />


    <int-sftp:outbound-channel-adapter id="createErrorFile"
                                       channel="errorUploadChannel"
                                       session-factory="sftpSessionFactory"
                                       auto-startup="true"
                                       charset="UTF-8"
                                       remote-file-separator="/"
                                       remote-directory-expression="'${sftp.directory.Documents}/' + headers['directory'] + '/'"
                                       auto-create-directory="true"
                                       remote-filename-generator-expression="headers['error_file_name']"
                                       order="1"
    />

    <int-sftp:outbound-gateway id="renameInvalidFile"
                               session-factory="sftpSessionFactory"
                               request-channel="errorUploadChannel"
                               reply-channel="nullChannel"
                               auto-startup="true"
                               remote-file-separator="/"
                               command="mv"
                               expression="'${sftp.directory.Documents}/' + headers['directory'] + '/' + headers['file_name']"
                               rename-expression="'${sftp.directory.Documents}/' + headers['directory'] + '/' + headers['short_file_name'] + '.error'"
                               order="2"
    />

    <bean id="redisConnectionFactory"
          class="org.springframework.data.redis.connection.jedis.JedisConnectionFactory">
        <property name="port" value="${redis.port}" />
        <property name="hostName" value="${redis.host}" />
    </bean>

    <bean name="metadataStore" class="org.springframework.integration.redis.metadata.RedisMetadataStore">
        <constructor-arg name="connectionFactory" ref="redisConnectionFactory"/>
    </bean>

</beans>